{"version":3,"file":"master.f28483dabffb03fa6c2b.bundle.js","mappings":"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","sources":["webpack://webao/./webAO/encoding.ts","webpack://webao/./webAO/master.ts"],"sourcesContent":["/**\n * Escapes a string to AO1 escape codes.\n * @param {string} estring the string to be escaped\n */\nexport function escapeChat(estring: string): string {\n  return estring\n    .replaceAll(\"#\", \"<num>\")\n    .replaceAll(\"&\", \"<and>\")\n    .replaceAll(\"%\", \"<percent>\")\n    .replaceAll(\"$\", \"<dollar>\");\n}\n\n/**\n * Unescapes a string to AO1 escape codes.\n * @param {string} estring the string to be unescaped\n */\nexport function unescapeChat(estring: string): string {\n  return estring\n    .replaceAll(\"<num>\", \"#\")\n    .replaceAll(\"<and>\", \"&\")\n    .replaceAll(\"<percent>\", \"%\")\n    .replaceAll(\"<dollar>\", \"$\");\n}\n\n/**\n * Escapes a string to be HTML-safe.\n *\n * XXX: This is unnecessary if we use `createTextNode` instead!\n * @param {string} unsafe an unsanitized string\n */\nexport function safeTags(unsafe: string): string {\n  if (unsafe) {\n    return unsafe.replaceAll(\">\", \"＞\").replaceAll(\"<\", \"＜\");\n  }\n  return \"\";\n}\n\n/**\n * Decodes text on client side.\n * @param {string} estring the string to be decoded\n */\nexport function decodeChat(estring: string): string {\n  // Source: https://stackoverflow.com/questions/7885096/how-do-i-decode-a-string-with-escaped-unicode\n  return estring.replace(/\\\\u([\\d\\w]{1,})/gi, (match, group) =>\n    String.fromCharCode(parseInt(group, 16)),\n  );\n}\n\n/**\n * XXX: a nasty hack made by gameboyprinter.\n * @param {string} msg chat message to prepare for display\n */\nexport function prepChat(msg: string): string {\n  // TODO: make this less awful\n  return safeTags(unescapeChat(decodeChat(msg)));\n}\n","import { safeTags } from \"./encoding\";\n\ninterface AOServer {\n  name: string;\n  description: string;\n  ip: string;\n  players: number;\n  online: string;\n  port?: number;\n  ws_port?: number;\n  wss_port?: number;\n  asset?: string;\n}\n\nconst clientVersion = process.env.npm_package_version;\n\n// const MASTERSERVER_IP = 'master.aceattorneyonline.com:27014';\nconst serverlist_domain = \"servers.aceattorneyonline.com\";\nconst protocol = window.location.protocol;\n\nconst serverlist_cache_key = \"masterlist\";\n\nconst servers: AOServer[] = [];\nservers[-1] = {\n  name: \"Localhost\",\n  description: \"This is your computer on port 50001\",\n  ip: \"127.0.0.1\",\n  players: 0,\n  online: \"Localhost\",\n  ws_port: 50001,\n} as AOServer;\n\nfunction main() {\n  getServerlist().then((serverlist) => {\n    processServerlist(serverlist);\n  });\n\n  addServer(servers[-1]);\n\n  processClientVersion(clientVersion);\n\n  getMasterVersion().then((masterVersion) => {\n    processMasterVersion(masterVersion);\n  });\n}\n\nmain();\n\n// Fetches the serverlist from the masterserver\n// Returns a properly typed list of servers\nasync function getServerlist(): Promise<AOServer[]> {\n  const url = `${protocol}//${serverlist_domain}/servers`;\n  const response = await fetch(url);\n\n  if (!response.ok) {\n    console.error(\n      `Bad status code from masterserver. status: ${response.status}, body: ${response.body}`,\n    );\n    document.getElementById(\"ms_error\").style.display = \"block\";\n    // If we get a bad status code, try to use the cached serverlist\n    return getCachedServerlist();\n  }\n\n  const data = await response.json();\n  const serverlist: AOServer[] = [];\n\n  for (const item of data) {\n    if (!item.name) {\n      console.warn(`Server ${item} has no name, skipping`);\n      continue;\n    }\n    if (!item.ip) {\n      console.warn(`Server ${item.name} has no ip, skipping`);\n      continue;\n    }\n    if (!item.description) {\n      console.warn(`Server ${item.name} has no description, skipping`);\n      continue;\n    }\n\n    const newServer: AOServer = {\n      name: item.name,\n      description: item.description,\n      ip: item.ip,\n      players: item.players || 0,\n      online: `Players: ${item.players}`,\n    };\n\n    if (item.ws_port) {\n      newServer.ws_port = item.ws_port;\n    }\n    if (item.wss_port) {\n      newServer.wss_port = item.wss_port;\n    }\n\n    // if none of ws_port or wss_port are defined, skip\n    // Note that this is not an error condition, as many servers only has port (TCP) enabled\n    // Which means they don't support webAO\n    if (!newServer.ws_port && !newServer.wss_port) {\n      continue;\n    }\n\n    serverlist.push(newServer);\n  }\n\n  // Always cache the result when we get it\n  localStorage.setItem(serverlist_cache_key, JSON.stringify(serverlist));\n\n  return serverlist;\n}\n\nfunction getCachedServerlist(): AOServer[] {\n  // If it's not in the cache, return an empty list\n  const cached = localStorage.getItem(serverlist_cache_key) || \"[]\";\n  return JSON.parse(cached) as AOServer[];\n}\n\n// Constructs the client URL robustly, independent of domain and path\nfunction constructClientURL(protocol: string): string {\n  const clientURL = new URL(window.location.href);\n\n  // Use the given protocol\n  clientURL.protocol = protocol;\n\n  // Remove the last part of the pathname (e.g., \"index.html\")\n  const pathname = clientURL.pathname;\n  const parts = pathname.split(\"/\");\n  parts.pop();\n\n  // Reconstruct the pathname\n  clientURL.pathname = parts.join(\"/\");\n\n  // If clientURL.pathname does not end with a slash, add one\n  if (clientURL.pathname[clientURL.pathname.length - 1] !== \"/\") {\n    clientURL.pathname += \"/\";\n  }\n\n  clientURL.pathname += \"client.html\";\n\n  return clientURL.href;\n}\n\nfunction addServer(server: AOServer) {\n  let ws_port = 0;\n  let ws_protocol = \"\";\n  let http_protocol = \"\";\n\n  if (server.ws_port) {\n    ws_port = server.ws_port;\n    ws_protocol = \"ws\";\n    http_protocol = \"http\";\n  }\n  if (server.wss_port && !window.navigator.userAgent.includes(\"Nintendo\")) {\n    ws_port = server.wss_port;\n    ws_protocol = \"wss\";\n    http_protocol = \"https\";\n  }\n\n  if (ws_port === 0 || ws_protocol === \"\" || http_protocol === \"\") {\n    console.warn(`Server ${server.name} has no websocket port, skipping`);\n    return;\n  }\n\n  const clientURL = constructClientURL(http_protocol);\n  const connect = `${ws_protocol}://${server.ip}:${ws_port}`;\n  const serverName = server.name;\n  const fullClientWatchURL = `${clientURL}?mode=watch&connect=${connect}&serverName=${serverName}`;\n  const fullClientJoinURL = `${clientURL}?mode=join&connect=${connect}&serverName=${serverName}`;\n\n  servers.push(server);\n\n  document.getElementById(\"masterlist\").innerHTML +=\n    `<details name=\"servers\">` +\n    `<summary><p>${safeTags(server.name)} (${server.players})</p>` +\n    `<a class=\"button\" href=\"${fullClientJoinURL}\" target=\"_blank\">Join</a>` +\n    `<a class=\"button\" href=\"${fullClientWatchURL}\" target=\"_blank\">Watch</a></summary>` +\n    `<p>${safeTags(server.description)}</p>` +\n    `</details>`;\n}\n\nfunction processServerlist(serverlist: AOServer[]) {\n  for (let i = 0; i < serverlist.length; i++) {\n    addServer(serverlist[i]);\n  }\n}\n\nasync function getMasterVersion(): Promise<string> {\n  const url = `${protocol}//${serverlist_domain}/version`;\n  const response = await fetch(url);\n  if (!response.ok) {\n    console.error(\n      `Bad status code from masterserver version check. status: ${response.status}, body: ${response.body}`,\n    );\n    return \"Unknown\";\n  }\n\n  return await response.text();\n}\n\nfunction processClientVersion(data: string) {\n  document.getElementById(\"clientinfo\").innerHTML = `Client version: ${data}`;\n}\n\nfunction processMasterVersion(data: string) {\n  document.getElementById(\"serverinfo\").innerHTML =\n    `Master server version: ${data}`;\n}\n"],"names":["safeTags","unsafe","replaceAll","serverlist_domain","protocol","window","location","serverlist_cache_key","servers","addServer","server","ws_port","ws_protocol","http_protocol","wss_port","navigator","userAgent","includes","console","warn","name","clientURL","URL","href","parts","pathname","split","pop","join","length","constructClientURL","connect","ip","serverName","fullClientWatchURL","fullClientJoinURL","push","document","getElementById","innerHTML","players","description","online","url","response","fetch","ok","error","status","body","style","display","cached","localStorage","getItem","JSON","parse","getCachedServerlist","data","json","serverlist","item","newServer","setItem","stringify","getServerlist","then","i","processServerlist","text","getMasterVersion","masterVersion","processMasterVersion"],"sourceRoot":""}